<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTT Station Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        tbody tr { transition: background-color 0.2s ease-in-out; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <header class="mb-10">
            <h1 class="text-4xl font-bold text-slate-900">Station Management Dashboard</h1>
            <p class="text-lg text-slate-600 mt-2">A central hub for viewing and managing station data.</p>
        </header>

        <div id="analytics-panel" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm">
                 <h2 class="text-xl font-semibold mb-4 text-slate-800 border-b pb-3">Add New Station</h2>
                 <form id="add-marker-form" class="space-y-4 mt-4">
                     <input required type="text" id="new-marker-id" placeholder="ID (e.g., 701)" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                     <input required type="text" id="new-marker-title" placeholder="Title (e.g., PTT Station Riverside)" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                     <input required type="text" id="new-marker-province" placeholder="Province (e.g., Phnom Penh)" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                     <button type="submit" class="w-full bg-sky-600 text-white font-bold py-3 px-4 rounded-md hover:bg-sky-700 transition duration-300">Add Station</button>
                 </form>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm">
                 <h2 class="text-xl font-semibold mb-4 text-slate-800 border-b pb-3">Bulk Update Stations</h2>
                 <form id="bulk-update-form" class="space-y-4 mt-4">
                     <textarea id="bulk-ids" rows="3" placeholder="Paste station IDs here..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500"></textarea>
                     <div id="bulk-id-validation" class="text-xs p-2 bg-slate-50 rounded min-h-[40px]"></div>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                         <input type="text" id="bulk-status" placeholder="New Status (optional)" class="p-3 bg-slate-50 border border-slate-200 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500">
                         <input type="text" id="bulk-province" placeholder="New Province (optional)" class="p-3 bg-slate-50 border border-slate-200 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500">
                     </div>
                     <button type="submit" class="w-full bg-amber-500 text-white font-bold py-3 px-4 rounded-md hover:bg-amber-600 transition duration-300">Apply Bulk Update</button>
                     <div id="bulk-update-result" class="text-center text-sm font-medium mt-2 h-6"></div>
                 </form>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="p-6 flex flex-wrap gap-4 justify-between items-center border-b">
                <div class="flex items-center gap-4">
                    <h2 class="text-xl font-semibold text-slate-800">Station Data</h2>
                    <select id="file-selector" class="p-2 bg-slate-50 border border-slate-200 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="default" selected>Default (markers.json)</option>
                        <option value="admin">Admin (markers_admin.json)</option>
                        <option value="admin_fleet">Admin Fleet (markers_admin_fleet.json)</option>
                    </select>
                </div>
                <a id="export-button" href="#" class="inline-block bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition duration-300">
                    Export to Excel
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                        <tr>
                            <th class="px-6 py-3">ID</th><th class="px-6 py-3">Title</th><th class="px-6 py-3">Province</th><th class="px-6 py-3">Status</th><th class="px-6 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="marker-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const fileSelector = document.getElementById('file-selector');
        const markerTableBody = document.getElementById('marker-table-body');
        const analyticsPanel = document.getElementById('analytics-panel');
        const exportButton = document.getElementById('export-button');
        const addMarkerForm = document.getElementById('add-marker-form');
        const bulkUpdateForm = document.getElementById('bulk-update-form');
        const bulkUpdateResult = document.getElementById('bulk-update-result');
        const bulkIdsTextarea = document.getElementById('bulk-ids');
        const bulkIdValidation = document.getElementById('bulk-id-validation');
        let currentMarkers = [];

        // --- Core Functions ---
        const fetchAndRenderMarkers = async (fileKey) => {
            try {
                const response = await fetch(`/api/markers/${fileKey}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                currentMarkers = await response.json();
                
                renderMarkers(currentMarkers, fileKey);
                calculateAndRenderStats(currentMarkers); // This function is now updated
                validateBulkIds();
                
                exportButton.href = `/api/export/${fileKey}`;
            } catch (error) {
                console.error("Fetch Error:", error);
                markerTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-red-500">Error loading data. Is the server running?</td></tr>`;
            }
        };

        // --- UPDATED Analytics Function ---
        const calculateAndRenderStats = (markers) => {
            if (!markers) return;

            const countItems = (key) => markers.flatMap(m => m[key] || []).reduce((acc, item) => {
                acc[item] = (acc[item] || 0) + 1;
                return acc;
            }, {});

            const stats = {
                total: markers.length,
                status: markers.reduce((acc, m) => { acc[m.status] = (acc[m.status] || 0) + 1; return acc; }, {}),
                services: countItems('service'),
                descriptions: countItems('description'),
            };

            const createStatCard = (title, value, items = {}) => {
                let listHtml = Object.entries(items).map(([key, count]) => `<li class="flex justify-between text-xs"><span>${key || 'N/A'}</span><span class="font-bold">${count}</span></li>`).join('');
                return `<div class="bg-white p-4 rounded-xl shadow-sm"><h3 class="font-semibold text-slate-500 text-sm">${title}</h3><p class="text-3xl font-bold text-slate-900">${value}</p>${listHtml ? `<ul class="mt-2 space-y-1 border-t pt-2">${listHtml}</ul>` : ''}</div>`;
            };
            
            // ** THE FIX IS HERE **
            // We now get the top 3 items first, and then use their length for the big number.
            const topStatuses = Object.fromEntries(Object.entries(stats.status).sort(([,a],[,b]) => b-a).slice(0, 3));
            const topServices = Object.fromEntries(Object.entries(stats.services).sort(([,a],[,b]) => b-a).slice(0, 3));
            const topAmenities = Object.fromEntries(Object.entries(stats.descriptions).sort(([,a],[,b]) => b-a).slice(0, 3));

            analyticsPanel.innerHTML = createStatCard('Total Stations', stats.total)
                + createStatCard('Top Statuses', Object.keys(topStatuses).length, topStatuses)
                + createStatCard('Top Services', Object.keys(topServices).length, topServices)
                + createStatCard('Top Amenities', Object.keys(topAmenities).length, topAmenities);
        };
        
        // --- All other JS functions remain the same ---
        const renderMarkers = (markers, fileKey) => {
            markerTableBody.innerHTML = '';
            if (!markers || markers.length === 0) { markerTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-slate-500">No markers found.</td></tr>`; return; }
            markers.forEach(marker => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-slate-50'; row.id = `marker-row-${marker.id}`;
                row.innerHTML = `<td class="px-6 py-4 font-medium text-slate-900">${marker.id}</td><td class="px-6 py-4">${marker.title || ''}</td><td class="px-6 py-4">${marker.province || ''}</td><td class="px-6 py-4">${marker.status || ''}</td><td class="px-6 py-4 text-right"><button onclick="toggleEditMode('${fileKey}', '${marker.id}')" class="font-medium text-indigo-600 hover:text-indigo-800 mr-4">Edit</button><button onclick="handleDelete('${fileKey}', '${marker.id}')" class="font-medium text-red-600 hover:text-red-800">Delete</button></td>`;
                markerTableBody.appendChild(row);
            });
        };
        const toggleEditMode = (fileKey, markerId) => {
            const marker = currentMarkers.find(m => String(m.id) === String(markerId)); const row = document.getElementById(`marker-row-${markerId}`); row.classList.add('bg-indigo-50');
            row.innerHTML = `<td class="px-6 py-4 font-medium text-slate-900">${marker.id}</td><td class="px-2 py-2"><input type="text" id="edit-title-${markerId}" value="${marker.title || ''}" class="w-full p-2 bg-white border rounded-md"></td><td class="px-2 py-2"><input type="text" id="edit-province-${markerId}" value="${marker.province || ''}" class="w-full p-2 bg-white border rounded-md"></td><td class="px-2 py-2"><input type="text" id="edit-status-${markerId}" value="${marker.status || ''}" class="w-full p-2 bg-white border rounded-md"></td><td class="px-6 py-4 text-right"><button onclick="handleSave('${fileKey}', '${marker.id}')" class="font-medium text-green-600 mr-4">Save</button><button onclick="renderMarkers(currentMarkers, '${fileKey}')" class="font-medium text-slate-600">Cancel</button></td>`;
        };
        const handleSave = async (fileKey, markerId) => {
            const updatedData = { title: document.getElementById(`edit-title-${markerId}`).value, province: document.getElementById(`edit-province-${markerId}`).value, status: document.getElementById(`edit-status-${markerId}`).value };
            try { await fetch(`/api/markers/${fileKey}/${markerId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(updatedData) }); await fetchAndRenderMarkers(fileKey); } catch (error) { alert(`Error: ${error.message}`); }
        };
        const validateBulkIds = () => {
            const validIdSet = new Set(currentMarkers.map(m => String(m.id))); const inputIds = bulkIdsTextarea.value.split(/\s+|,/).map(id => id.trim()).filter(id => id); if (inputIds.length === 0) { bulkIdValidation.innerHTML = '<span class="text-slate-400">Paste IDs...</span>'; return; } const foundIds = []; const notFoundIds = []; inputIds.forEach(id => { if (validIdSet.has(id)) { foundIds.push(id); } else { notFoundIds.push(id); } }); let html = ''; if (foundIds.length > 0) { html += `<div class="text-green-600 font-semibold">Found (${foundIds.length}): ${foundIds.join(', ')}</div>`; } if (notFoundIds.length > 0) { html += `<div class="text-red-600 font-semibold mt-1">Not Found (${notFoundIds.length}): ${notFoundIds.join(', ')}</div>`; } bulkIdValidation.innerHTML = html;
        };
        const handleAddMarker = async (event) => {
            event.preventDefault(); const newMarker = { id: document.getElementById('new-marker-id').value, title: document.getElementById('new-marker-title').value, province: document.getElementById('new-marker-province').value, description: [], product: [], service: [], status: "active" }; try { const response = await fetch(`/api/markers/${fileSelector.value}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(newMarker) }); if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error || 'Failed to add marker'); } addMarkerForm.reset(); await fetchAndRenderMarkers(fileSelector.value); } catch (error) { alert(`Error: ${error.message}`); }
        };
        const handleDelete = async (fileKey, markerId) => {
            if (!confirm(`Delete marker ID ${markerId}?`)) return; try { await fetch(`/api/markers/${fileKey}/${markerId}`, { method: 'DELETE' }); await fetchAndRenderMarkers(fileKey); } catch (error) { alert(`Error: ${error.message}`); }
        };
        const handleBulkUpdate = async (event) => {
            event.preventDefault(); bulkUpdateResult.textContent = 'Processing...'; const fileKey = fileSelector.value; const idsToUpdate = bulkIdsTextarea.value.split(/\s+|,/).map(id => id.trim()).filter(id => id); const changes = {}; const newStatus = document.getElementById('bulk-status').value.trim(); const newProvince = document.getElementById('bulk-province').value.trim(); if (newStatus) changes.status = newStatus; if (newProvince) changes.province = newProvince; if (idsToUpdate.length === 0 || Object.keys(changes).length === 0) { bulkUpdateResult.textContent = 'Please provide IDs and at least one change.'; return; } const payload = idsToUpdate.map(id => ({ id, changes })); try { const response = await fetch(`/api/markers/${fileKey}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); const result = await response.json(); if (!response.ok) throw new Error(result.error || 'Bulk update failed'); bulkUpdateResult.innerHTML = `<span class="text-green-600">Updated: ${result.updated_ids.length}</span> | <span class="text-red-500">Not Found: ${result.not_found_ids.length}</span>`; bulkUpdateForm.reset(); validateBulkIds(); await fetchAndRenderMarkers(fileKey); } catch (error) { bulkUpdateResult.textContent = `Error: ${error.message}`; }
        };

        // --- Event Listeners ---
        fileSelector.addEventListener('change', (e) => fetchAndRenderMarkers(e.target.value));
        addMarkerForm.addEventListener('submit', handleAddMarker);
        bulkUpdateForm.addEventListener('submit', handleBulkUpdate);
        bulkIdsTextarea.addEventListener('input', validateBulkIds);
        document.addEventListener('DOMContentLoaded', () => fetchAndRenderMarkers(fileSelector.value));
    </script>
</body>
</html>